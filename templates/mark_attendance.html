{% extends "base.html" %}

{% block title %}Mark Attendance{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-check-circle"></i> Mark Attendance</h1>
    <p>Available active sessions for attendance marking</p>
</div>

{% if sessions %}
    {% set selected = (requested_session_id if requested_session_id is defined else None) %}

    <div style="margin-bottom: 16px;">
        <label for="sessionSelect" style="font-weight:600; margin-bottom:6px; display:block;">
            Choose a session
        </label>
        <select id="sessionSelect" class="form-select">
            {% for s in sessions %}
                <option value="{{ s.id }}" {% if selected == s.id %}selected{% endif %}>
                    {{ s.course_name }} — {{ s.name }} ({{ s.location }})
                </option>
            {% endfor %}
        </select>
        <small style="color:#64748b;">
            Tip: You can also click “Mark Attendance” directly in the table.
        </small>
    </div>
{% endif %}

<div class="table-responsive">
    {% if sessions %}
    <table>
        <thead>
            <tr>
                <th>Session Name</th>
                <th>Course</th>
                <th>Location</th>
                <th>Time</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for session in sessions %}
            <tr id="session-{{ session.id }}">
                <td>{{ session.name }}</td>
                <td>{{ session.course_name }}</td>
                <td>{{ session.location }}</td>
                <td>
                    {# If you later add session start_time into the dict, show it here #}
                    {% if session.start_time is defined and session.start_time %}
                        {{ session.start_time }}
                    {% elif session.marked_time %}
                        {{ session.marked_time.strftime('%I:%M %p') }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                    {% if session.already_marked %}
                        <span class="status-badge" style="background-color: #dcfce7; color: #166534;">
                            <i class="fas fa-check"></i> Marked
                        </span>
                    {% else %}
                        <span class="status-badge" style="background-color: #fef3c7; color: #92400e;">
                            <i class="fas fa-clock"></i> Pending
                        </span>
                    {% endif %}
                </td>
                <td>
                    {% if not session.already_marked %}
                        <button
                            type="button"
                            class="btn btn-primary btn-sm"
                            onclick="markAttendance('{{ session.id }}', this)">
                            <i class="fas fa-location-dot"></i> Mark Attendance
                        </button>
                    {% else %}
                        <span style="color: #64748b;">Attendance already marked</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 40px;">
        <i class="fas fa-calendar-times" style="font-size: 48px; color: #cbd5e1; margin-bottom: 20px;"></i>
        <h3>No Active Sessions</h3>
        <p style="color: #64748b;">There are no active sessions available for attendance marking at this time.</p>
    </div>
    {% endif %}
</div>

{% if requested_session_id is defined and requested_session_id %}
<script>
  (function () {
    const el = document.getElementById("session-{{ requested_session_id }}");
    if (el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
      el.style.outline = "2px solid #0d6efd";
      el.style.borderRadius = "8px";
    }
  })();
</script>
{% endif %}

<script>
async function markAttendance(sessionId, btn) {
    // btn is passed explicitly to avoid relying on global `event`
    const originalHTML = btn ? btn.innerHTML : "";

    try {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
        }

        // Loading state
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking location...';
            btn.disabled = true;
        }

        // Ask for location permission
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });

        const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
        };

        // Send to server
        const response = await fetch('/api/attendance/mark', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                ...locationData
            })
        });

        const result = await response.json();

        if (result.success) {
            alert(`✅ ${result.message}`);
            location.reload();
        } else {
            alert(`❌ ${result.message}`);
            if (btn) {
                btn.innerHTML = originalHTML || '<i class="fas fa-location-dot"></i> Mark Attendance';
                btn.disabled = false;
            }
        }

    } catch (error) {
        const msg = (error && error.message) ? error.message : String(error);
        alert(`Location error: ${msg}`);

        if (btn) {
            btn.innerHTML = originalHTML || '<i class="fas fa-location-dot"></i> Mark Attendance';
            btn.disabled = false;
        }
    }
}
</script>
{% endblock %}
